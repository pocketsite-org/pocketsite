<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocketsite</title>

    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://unpkg.com/pocketbase@0.20.1/dist/pocketbase.umd.js"></script>
    <link rel="stylesheet" href="/assets/css/utils.css">
    <link rel="stylesheet" href="/assets/css/normalize.css">
    <script src="/assets/js/utils.js" defer></script>

    <!-- Add CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

    <!-- Add CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
</head>

<body>
    <div id="app">
        <div id="header" hx-get="/components/header.html" hx-trigger="load"></div>

        <main>
            <div id="content">
                <!-- Content will be loaded by script -->
            </div>
        </main>
    </div>
</body>

<style>
    main {
        padding-left: 10px;
        padding-right: 10px;
    }
</style>

<script>
    // Load last page or default to dashboard
    document.addEventListener('DOMContentLoaded', function () {
        const lastPage = localStorage.getItem('currentPage') || '/pages/dashboard.html';
        htmx.ajax('GET', lastPage, '#content');
    });

    // Event Listeners for HTMX integration
    document.body.addEventListener('htmx:beforeRequest', function (evt) {
        const path = evt.detail.requestConfig.path;

        // Store current page in localStorage
        if (evt.detail.elt.id === 'content' || evt.detail.target.id === 'content') {
            localStorage.setItem('currentPage', path);
        }

        if (!window.pbFunctions.auth.isAuthenticated()) {
            if (!path.includes('login')) {
                evt.preventDefault();
                htmx.ajax('GET', '/pages/login.html', '#content');
            }
        } else {
            const token = window.pbFunctions.auth.getToken();
            if (token && token.trim().length > 0) {
                evt.detail.headers = evt.detail.headers || {};
                evt.detail.headers['Authorization'] = 'Bearer ' + token;
            }
        }
    });

    document.body.addEventListener('htmx:responseError', function (evt) {
        if (evt.detail.status === 401) {
            window.pbFunctions.auth.logout();
        }
    });

    document.body.addEventListener('htmx:afterRequest', function (evt) {
        if (evt.detail.elt.id === 'content') {
            evt.detail.elt.classList.remove('loading');
        }
    });
</script>

</html>