<h1>Pages</h1>

<div class="page-header">
    <button class="create-btn" onclick="createPage()">Create New Page</button>
</div>

<div id="pages-list">
    <table class="pages-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Excerpt</th>
                <th>Endpoint</th>
                <th>Author</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="pages-tbody">
            <!-- Pages will be inserted here -->
        </tbody>
    </table>
</div>

<style>
    .pages-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .pages-table th,
    .pages-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .pages-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .pages-table tr:hover {
        background-color: #f5f5f5;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-buttons button {}

    .edit-btn {}

    .delete-btn {}
</style>

<script>
    window.pbFunctions.collections.getList('posts', 1, 50, {
        filter: 'type="page"',
        expand: 'author',
    }
    ).then((pages) => {
        const tableBody = document.getElementById('pages-tbody');
        tableBody.innerHTML = '';

        console.log('Pages:', pages);

        pages.items.forEach((page) => {

            const authorName = page.expand?.author?.[0]?.name || 'No author';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${page.title}</td>
                <td>${page.excerpt}</td>
                <td>${page.name}</td>
                <td>${authorName}</td>
                <td>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editPage('${page.id}')">Edit</button>
                        <button class="delete-btn" onclick="deletePage('${page.id}')">Delete</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    });

    async function createPage() {
    const author = window.pbFunctions.auth.getCurrentUser();
    const authorId = author?.id || 'No author';
    
    try {
        // Get header and footer objects using getList
        const headerList = await window.pbFunctions.collections.list('posts', 1, 1, {
            filter: `name='/header'`
        });
        
        const footerList = await window.pbFunctions.collections.list('posts', 1, 1, {
            filter: `name='/footer'`
        });

        // Create objects array with header and footer IDs
        const objects = [];
        if (footerList.items.length > 0) objects.push(footerList.items[0].id);
        if (headerList.items.length > 0) objects.push(headerList.items[0].id);
        
        // Create a new empty page with objects
        const newPage = await window.pbFunctions.collections.create('posts', {
            title: 'New Page',
            name: '/new-page-' + Date.now(),
            excerpt: '',
            content: '',
            type: 'page',
            status: 'draft',
            author: authorId,
            objects: objects,
            parent: '',
            created: new Date().toISOString(),
            updated: new Date().toISOString()
        });
        
        // Store the new page ID and navigate to edit page
        localStorage.setItem('editPageId', newPage.id);
        htmx.ajax('GET', '/pages/edit.html', '#content');
    } catch (error) {
        console.error('Error creating page:', error);
        alert('Failed to create page');
    }
}
    function editPage(id) {
        // Store page ID in localStorage
        localStorage.setItem('editPageId', id);
        // Navigate to edit page without query parameter
        htmx.ajax('GET', '/pages/edit.html', '#content');
    }

    function deletePage(id) {
        if (confirm('Are you sure you want to delete this page?')) {
            window.pbFunctions.collections.delete('posts', id)
                .then(() => {
                    // Refresh the table
                    htmx.ajax('GET', '/pages/pages.html', '#content');
                })
                .catch((error) => {
                    console.error('Error deleting page:', error);
                    alert('Failed to delete page');
                });
        }
    }
</script>